---
layout: post
title: "iptables"
description: "linux firewall: iptables"
category: "linux"
tags: [linux, iptables]
---
{% include JB/setup %}

http://vbird.dic.ksu.edu.tw/linux_server/0250simple_firewall_1.php

### 防火墙

防火墙最基本的功能就是隔离网络，通过将网络划分成不同的区域（通常情况下称为ZONE），制定出不同区域之间的访问控制策略来控制不同任程度区域间传送的数据流。

根据防火墙是否需要硬件设备来分，防火墙分为硬件防火墙和软件防火墙。

根据防火墙管理的范围，防火墙分为网域型和单一主机型。单一主机型的控管方面，主要有封包过滤型的Netfilter（封包过滤机制）和依据服务软件程序作为分析的TCP Wrappers（程序控管）两种。

### Netfilter(封包过滤机制)

所谓的封包过滤，就是分析进入主机的网络封包，将封包的表头数据提取出来进行分析，以决定是否放行该封包。在Linux上使用核心内建的Netfilter(Netfilter是内核提供的)，而Netfilter提供了**iptables**这个软件来作为防火墙包过滤的指令。Netfilter通过设置的包过滤规则决定封包是接收还是扔掉。

### iptables(Linux的包过滤软件)

其工作原理大概是：_当接收到一个包时，提取包的表头数据与预先定义的规则进行对比，若与规则相同相同则进行该规则定义的动作（动作一般就是ACCEPT、REJECT），否则就继续下一条规则。_

所以需要注意，**规则是有顺序的**，若包的表头数据匹配到了一条规则，就会执行该规则定义的动作，之后就算再有规则与该包匹配也不会被执行了。

#### iptables的表格(table)与链(chain)

iptables里面有多个表格(table)，每个表格都定义出自己的默认政策与规则，且每个表格的用途都不相同。

[[iptables 的表格与相关链示意图](http://vbird.dic.ksu.edu.tw/linux_server/0250simple_firewall_files/iptables_02.png) ]({{ site.img_url }}/iptables/iptables_02.png)

* filter : 主要跟进入Linux本机的包有关，预设的table
> INPUT: 主要与想进入Linux本机的包有关
> OUTPUT: 主要与Linux本机要送出的包有关
> FORWARD: 转递包到其他的计算机中，与nat table相关性较高
* nat(Network Address Translation) : 进行来源与目的之间IP或端口的转换，与Linux本机无关，主要与Linux主机所在的局域网内计算机相关。
> PREROUTING: 在进行路由判断之前要进行的规则(DNAT/REDIRECT)
> POSTROUTING: 在进行路由判断之后要进行的规则(SNAT/MASQUERADE)
> OUTPUT: 与发送出去的封包有关

### iptables的语法

iptables命令：
	[root@www ~]# iptables [-t tables] [-L] [-nv]
	选项与参数：
	-t ：后面接 table ，例如 nat 或 filter ，若省略此项目，则使用默认的 filter
	-L ：列出目前的 table 的规则
	-n ：不进行 IP 与 HOSTNAME 的反查，显示讯息的速度会快很多！
	-v ：列出更多的信息，包括通过该规则的封包总位数、相关的网络接口等

	范例：列出 filter table 三条链的规则
	[root@www ~]# iptables -L -n
	Chain INPUT (policy ACCEPT)   <==针对 INPUT 链，且预设政策为可接受
	target  prot opt source     destination <==说明栏
	ACCEPT  all  --  0.0.0.0/0  0.0.0.0/0   state RELATED,ESTABLISHED <==第 1 条规则
	ACCEPT  icmp --  0.0.0.0/0  0.0.0.0/0                             <==第 2 条规则
	ACCEPT  all  --  0.0.0.0/0  0.0.0.0/0                             <==第 3 条规则
	ACCEPT  tcp  --  0.0.0.0/0  0.0.0.0/0   state NEW tcp dpt:22      <==以下类推
	REJECT  all  --  0.0.0.0/0  0.0.0.0/0   reject-with icmp-host-prohibited

	Chain FORWARD (policy ACCEPT)  <==针对 FORWARD 链，且预设政策为可接受
	target  prot opt source     destination
	REJECT  all  --  0.0.0.0/0  0.0.0.0/0   reject-with icmp-host-prohibited

	Chain OUTPUT (policy ACCEPT)  <==针对 OUTPUT 链，且预设政策为可接受
	target  prot opt source     destination

	范例：列出 nat table 三条链的规则
	[root@www ~]# iptables -t nat -L -n
	Chain PREROUTING (policy ACCEPT)
	target     prot opt source               destination

	Chain POSTROUTING (policy ACCEPT)
	target     prot opt source               destination

	Chain OUTPUT (policy ACCEPT)
	target     prot opt source               destination

iptables-save会列出完整的防火墙规则

	[root@www ~]# iptables-save [-t table]
	选项与参数：
	-t ：可以仅针对某些表格来输出，例如仅针对 nat 或 filter 等等

	[root@www ~]# iptables-save
	# Generated by iptables-save v1.4.7 on Fri Jul 22 15:51:52 2011
	*filter                      <==星号开头的指的是表格，这里为 filter
	:INPUT ACCEPT [0:0]          <==冒号开头的指的是链，三条内建的链
	:FORWARD ACCEPT [0:0]        <==三条内建链的政策都是 ACCEPT 啰！
	:OUTPUT ACCEPT [680:100461]
	-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT <==针对 INPUT 的规则
	-A INPUT -p icmp -j ACCEPT
	-A INPUT -i lo -j ACCEPT  <==这条很重要！针对本机内部接口开放！
	-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
	-A INPUT -j REJECT --reject-with icmp-host-prohibited
	-A FORWARD -j REJECT --reject-with icmp-host-prohibited <==针对 FORWARD 的规则
	COMMIT
	# Completed on Fri Jul 22 15:51:52 2011

